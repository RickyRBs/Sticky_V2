<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard</title>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">
    <style>
        body { overflow-y: auto; padding-top: 100px; padding-bottom: 40px; height: auto; }
        .card { margin: 0 auto; justify-content: flex-start; align-items: stretch; }

        /* Two-column layout with vertical divider */
        .rank-grid {
            display: flex;
            align-items: flex-start;
            gap: 0;
            width: 100%;
        }
        .rank-col {
            flex: 1;
            min-width: 0;
        }
        .rank-col:first-child {
            padding-right: 24px;
            border-right: 2px solid #000;
        }
        .rank-col:last-child {
            padding-left: 24px;
        }

        /* Section title inside each column */
        .section-title {
            font-size: 12px; font-weight: 800; text-transform: uppercase;
            letter-spacing: 1.5px; color: #666;
            margin: 0 0 14px 0; padding-bottom: 8px;
            border-bottom: 2px solid #000;
        }

        /* Rank list */
        .rank-list { display: flex; flex-direction: column; gap: 10px; }
        .rank-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 14px; background: #fff;
            border: 1px solid #000; cursor: pointer; transition: background 0.15s;
        }
        .rank-item:active { background: #fafafa; }
        .rank-left { display: flex; align-items: center; gap: 12px; }
        .rank-idx { width: 18px; font-weight: 800; font-style: italic; color: #ddd; text-align: center; font-size: 13px; flex-shrink: 0; }
        .rank-item:nth-child(1) .rank-idx { color: #FFD700; font-size: 18px; }
        .rank-item:nth-child(2) .rank-idx { color: #C0C0C0; font-size: 16px; }
        .rank-item:nth-child(3) .rank-idx { color: #CD7F32; font-size: 16px; }
        .rank-avatar { width: 36px; height: 36px; object-fit: cover; background: #eee; border: 1px solid #000; filter: grayscale(100%); flex-shrink: 0; }
        .user-info { display: flex; flex-direction: column; }
        .user-name { font-weight: 600; font-size: 13px; color: #111; }
        .user-id-tag { font-size: 9px; color: #888; font-family: monospace; background: #f5f5f7; padding: 1px 5px; border: 1px solid #ddd; margin-top: 3px; width: fit-content; }
        .rank-days { font-weight: 800; font-size: 16px; color: #111; flex-shrink: 0; }
        .rank-days span { font-size: 9px; font-weight: normal; color: #888; }

        /* Responsive: stack columns on small screens */
        @media (max-width: 600px) {
            .rank-grid { flex-direction: column; gap: 24px; }
            .rank-col:first-child { padding-right: 0; border-right: none; border-bottom: 2px solid #000; padding-bottom: 24px; }
            .rank-col:last-child { padding-left: 0; }
        }
    </style>
</head>
<body>
    <div class="topbar">
        <a href="index.html" class="logo">Sticky</a>
        <nav class="topnav">
            <a href="dlc.html">DLC</a>
            <a href="index.html">Home</a>
            <a href="leaderboard.html">Rank</a>
            <a href="social.html">Social</a>
            <a href="gallery.html">Gallery</a>
            <a href="profile.html">Me</a>
            <a id="authBtn" href="login.html">Login</a>
        </nav>
    </div>

    <div class="container">
        <div class="card">
            <div class="rank-grid">
                <!-- Left column: Top Players -->
                <div class="rank-col">
                    <p class="section-title">Top Players</p>
                    <div id="globalList" class="rank-list">Loading...</div>
                </div>

                <!-- Right column: Top Groups -->
                <div class="rank-col">
                    <p class="section-title">Top Groups</p>
                    <div id="groupRankList" class="rank-list">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import supabase from './js/supabaseClient.js';
        import { getCurrentUser } from './js/auth.js';

        async function init() {
            const user = await getCurrentUser();
            if (!user) return window.location.href = 'login.html';

            const authBtn = document.getElementById('authBtn');
            authBtn.textContent = 'Logout';
            authBtn.href = '#';
            authBtn.onclick = async (e) => {
                e.preventDefault();
                await supabase.auth.signOut();
                window.location.href = 'login.html';
            };

            loadGlobalRank();
            loadGroupRank();
        }

        async function loadGlobalRank() {
            const list = document.getElementById('globalList');
            const { data: profiles } = await supabase
                .from('profiles')
                .select('id, username, avatar_url, total_check_ins')
                .order('total_check_ins', { ascending: false })
                .limit(50);
            renderPlayerList(list, profiles);
        }

        async function loadGroupRank() {
            const list = document.getElementById('groupRankList');
            const { data: groups } = await supabase
                .from('groups')
                .select('id, name, total_group_check_ins')
                .order('total_group_check_ins', { ascending: false })
                .limit(50);

            if (!groups || groups.length === 0) {
                list.innerHTML = '<p class="empty-state">No groups yet</p>';
                return;
            }

            list.innerHTML = groups.map((g, i) => `
                <div class="rank-item" style="cursor:default;">
                    <div class="rank-left">
                        <div class="rank-idx">${i + 1}</div>
                        <div class="user-info">
                            <span class="user-name">${g.name}</span>
                        </div>
                    </div>
                    <div class="rank-days">${g.total_group_check_ins || 0}<span>d</span></div>
                </div>
            `).join('');
        }

        function renderPlayerList(container, profiles) {
            if (!profiles || profiles.length === 0) {
                container.innerHTML = '<p class="empty-state">Keep Sticking</p>';
                return;
            }
            container.innerHTML = profiles.map((p, i) => {
                let avatar = p.avatar_url || `https://ui-avatars.com/api/?name=${p.username}&background=random`;
                if (p.avatar_url) avatar += '?t=' + Date.now();
                return `
                    <div class="rank-item" onclick="window.location.href='profile.html?id=${p.id}'">
                        <div class="rank-left">
                            <div class="rank-idx">${i + 1}</div>
                            <img src="${avatar}" class="rank-avatar">
                            <div class="user-info">
                                <span class="user-name">${p.username}</span>
                                <span class="user-id-tag">UID: ${p.id.substring(0, 6)}</span>
                            </div>
                        </div>
                        <div class="rank-days">${p.total_check_ins || 0}<span>d</span></div>
                    </div>`;
            }).join('');
        }

        init();
    </script>
</body>
</html>
